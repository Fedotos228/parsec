import { readFileSync } from 'fs'
import { ImageResponse } from 'next/og'
import { join } from 'path'

export const alt = 'Parsec | Consultanță Strategică și PR'
export const size = { width: 1200, height: 630 }
export const contentType = 'image/png'
export const dynamic = 'force-dynamic'

// Această funcție transformă Buffer-ul de Node.js într-un ArrayBuffer pur
// Rezolvă eroarea: TypeError: Cannot read properties of undefined (reading '256')
function toArrayBuffer(buffer: Buffer) {
  const ab = new ArrayBuffer(buffer.length)
  const view = new Uint8Array(ab)
  for (let i = 0; i < buffer.length; ++i) {
    view[i] = buffer[i]
  }
  return ab
}

const LOGO_SVG = `<svg width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M84.9633 198.562C89.7456 199.285 94.5832 199.608 99.4153 199.686V199.998C64.8434 200.232 32.1258 181.662 14.2974 151.887C-7.74316 115.354 -3.61955 69.4863 21.9745 37.4513C22.4007 37.9467 22.8546 38.4198 23.3361 38.8651C-2.23579 70.4549 -5.94427 115.816 15.2107 151.336C28.7605 174.331 51.8748 191.381 77.8452 197.192C80.1201 197.743 82.6607 198.189 84.9633 198.562Z" fill="white" fill-opacity="0.75"/><path d="M199.998 100.581H196.24C196.19 94.6078 195.764 88.6183 194.657 82.7457C194.281 80.4411 193.694 77.9863 193.146 75.7319C175.799 10.5541 102.797 -15.9702 49.0742 16.4935C48.6591 15.8812 48.2052 15.2967 47.7126 14.7456C104.032 -19.9168 178.877 9.11236 196.594 74.8246C198.819 83.2132 199.91 91.8969 199.998 100.581Z" fill="white" fill-opacity="0.75"/><path d="M34.9379 40.0897C42.5618 40.0897 48.7423 33.8742 48.7423 26.207C48.7423 18.5397 42.5618 12.3242 34.9379 12.3242C27.3139 12.3242 21.1335 18.5397 21.1335 26.207C21.1335 33.8742 27.3139 40.0897 34.9379 40.0897Z" fill="white"/><path d="M43.0246 111.474C42.1003 110.044 40.783 108.942 39.0837 108.179C37.3734 107.411 35.3309 107.032 32.9564 107.032H22.473V135.199H25.4343V126.303H32.9564C35.3309 126.303 37.3734 125.914 39.0837 125.134C40.783 124.355 42.0948 123.253 43.0246 121.817C43.9435 120.386 44.4029 118.677 44.4029 116.684C44.4029 114.692 43.9435 112.91 43.0246 111.474ZM39.2663 121.861C37.8106 123.08 35.6741 123.687 32.8789 123.687H25.4398V109.61H32.8789C35.6796 109.61 37.8106 110.227 39.2663 111.458C40.7165 112.699 41.4416 114.436 41.4416 116.684C41.4416 118.933 40.711 120.637 39.2663 121.861Z" fill="white"/><path d="M62.5028 107.032H59.5803L46.7777 135.199H49.8663L53.215 127.673H68.8404L72.1891 135.199H75.3109L62.5083 107.032H62.5028ZM54.2832 125.262L61.0304 110.11L67.7666 125.262H54.2832Z" fill="white"/><path d="M99.6652 125.535C100.042 125.418 100.401 125.274 100.756 125.118C102.466 124.355 103.778 123.253 104.697 121.817C105.615 120.386 106.075 118.677 106.075 116.684C106.075 114.692 105.615 112.91 104.697 111.474C103.778 110.044 102.466 108.942 100.756 108.179C99.0453 107.411 97.0028 107.032 94.6394 107.032H84.1505V135.199H87.1172V126.27H94.6394C95.4198 126.27 96.1781 126.225 96.8866 126.136L103.274 135.204H106.512L99.6652 125.541V125.535ZM94.5563 123.732H87.1172V109.61H94.5563C97.3515 109.61 99.477 110.227 100.933 111.458C102.388 112.699 103.108 114.436 103.108 116.684C103.108 118.933 102.388 120.648 100.933 121.878C99.477 123.108 97.3515 123.732 94.5563 123.732Z" fill="white"/><path d="M125.192 135.438C123.111 135.438 121.119 135.098 119.209 134.414C117.299 133.729 115.827 132.85 114.786 131.781L115.949 129.487C116.934 130.45 118.263 131.263 119.929 131.92C121.595 132.577 123.349 132.905 125.192 132.905C127.036 132.905 128.386 132.683 129.493 132.243C130.6 131.798 131.414 131.202 131.934 130.45C132.454 129.699 132.715 128.87 132.715 127.957C132.715 126.854 132.399 125.975 131.774 125.301C131.148 124.633 130.323 124.099 129.31 123.709C128.298 123.32 127.174 122.98 125.951 122.685C124.722 122.39 123.499 122.073 122.27 121.739C121.041 121.405 119.917 120.954 118.888 120.392C117.858 119.83 117.034 119.084 116.408 118.16C115.783 117.236 115.467 116.022 115.467 114.519C115.467 113.122 115.833 111.842 116.569 110.678C117.299 109.509 118.429 108.574 119.951 107.862C121.473 107.149 123.416 106.793 125.79 106.793C127.362 106.793 128.923 107.016 130.473 107.455C132.017 107.895 133.351 108.507 134.475 109.287L133.473 111.658C132.272 110.856 130.999 110.266 129.654 109.888C128.309 109.515 127.008 109.326 125.751 109.326C124.069 109.326 122.685 109.554 121.589 110.01C120.493 110.467 119.691 111.079 119.17 111.842C118.65 112.604 118.39 113.473 118.39 114.436C118.39 115.538 118.705 116.423 119.331 117.091C119.956 117.759 120.786 118.282 121.81 118.661C122.834 119.039 123.964 119.373 125.192 119.668C126.421 119.963 127.639 120.286 128.851 120.631C130.063 120.982 131.187 121.427 132.211 121.978C133.235 122.529 134.691 124.171C135.316 125.084 135.631 127.751 135.631 129.12 135.255 130.384 134.513 131.553C133.766 132.722 132.626 133.657 131.093 134.369C129.56 135.082 127.595 135.438 125.192 135.438Z" fill="white"/><path d="M164.314 132.616V135.193H144.515V107.032H163.711V109.61H147.471V119.624H161.956V122.156H147.471V132.616H164.314Z" fill="white"/><path d="M187.838 135.438C185.729 135.438 183.781 135.082 181.999 134.369C180.211 133.657 178.667 132.66 177.36 131.374C176.054 130.089 175.036 128.574 174.299 126.827C173.563 125.084 173.198 123.181 173.198 121.115C173.198 119.05 173.563 117.147 174.299 115.404C175.03 113.662 176.06 112.142 177.382 110.856C178.7 109.571 180.255 108.569 182.043 107.856C183.831 107.144 185.779 106.787 187.882 106.787C189.986 106.787 191.818 107.127 193.606 107.812C195.394 108.496 196.899 109.52 198.128 110.89L196.246 112.782C195.1 111.602 193.833 110.751 192.443 110.227C191.054 109.704 189.565 109.443 187.96 109.443C186.277 109.443 184.722 109.732 183.277 110.305C181.838 110.884 180.582 111.702 179.519 112.76C178.451 113.818 177.62 115.054 177.017 116.462C176.419 117.87 176.115 119.418 176.115 121.11C176.115 122.802 176.414 124.35 177.017 125.758C177.615 127.166 178.451 128.402 179.519 129.46C180.587 130.517 181.838 131.335 183.277 131.914C184.716 132.493 186.277 132.777 187.96 132.777C189.643 132.777 191.054 132.51 192.443 131.97C193.833 131.436 195.095 130.578 196.246 129.393L198.128 131.285C196.899 132.655 195.394 133.684 193.606 134.38C191.818 135.076 189.897 135.427 187.844 135.427L187.838 135.438Z" fill="white"/></svg>`

export default async function Image() {
  try {
    // 1. Citim resursele locale
    const garamondBuffer = readFileSync(join(process.cwd(), 'public/fonts/garamond/EBGaramond-VariableFont.ttf'))
    const hellixBuffer = readFileSync(join(process.cwd(), 'public/fonts/helix/Hellix-Regular.ttf'))
    const bgImageBuffer = readFileSync(join(process.cwd(), 'public/Ilustratie.png'))

    // 2. Convertim explicit Buffer -> ArrayBuffer
    const fontGaramond = toArrayBuffer(garamondBuffer)
    const fontHellix = toArrayBuffer(hellixBuffer)
    const bgBase64 = `data:image/png;base64,${bgImageBuffer.toString('base64')}`

    return new ImageResponse(
      (
        <div style={{
          height: '100%',
          width: '100%',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          backgroundColor: '#000',
          position: 'relative',
        }}>
          <img 
            src={bgBase64} 
            style={{ 
              position: 'absolute', 
              top: 0, 
              left: 0, 
              width: '1200px', 
              height: '630px', 
              opacity: 0.3, 
              objectFit: 'cover' 
            }} 
          />
          <div style={{
            position: 'absolute',
            inset: 0,
            background: 'radial-gradient(circle, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.8) 100%)',
          }} />
          
          <div style={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 10,
            padding: '40px',
          }}>
            <div 
              style={{ display: 'flex', width: '160px', height: '160px', marginBottom: '40px' }} 
              dangerouslySetInnerHTML={{ __html: LOGO_SVG }} 
            />
            <div style={{ 
              fontSize: 68, 
              fontFamily: 'EB Garamond', 
              color: '#fff', 
              textAlign: 'center', 
              lineHeight: 1.1 
            }}>
              Consultanță Strategică și PR Full-Service
            </div>
            <div style={{ 
              fontSize: 28, 
              fontFamily: 'Hellix', 
              color: '#ccc', 
              marginTop: '20px', 
              textAlign: 'center', 
              maxWidth: '850px' 
            }}>
              Eficiență și Calitate în Comunicare
            </div>
          </div>
        </div>
      ),
      {
        ...size,
        fonts: [
          { name: 'EB Garamond', data: fontGaramond, weight: 700, style: 'normal' },
          { name: 'Hellix', data: fontHellix, weight: 400, style: 'normal' },
        ],
      }
    )
  } catch (e: any) {
    console.error(`OG Root Error: ${e.message}`)
    return new ImageResponse(
      <div style={{ backgroundColor: 'black', color: 'white', height: '100%', width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
        Parsec Strategic Consulting
      </div>,
      { ...size }
    )
  }
}